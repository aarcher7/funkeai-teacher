<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISU Teacher</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- Google Sign-In API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            background-color: #5A91E6;
            margin: 0;
            padding: 0;
        }
        /* Updated header background color and layout */
        .header {
            background: #3F72AF; /* New, softer blue */
            color: white;
            padding: 10px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        /* Left, center, and right containers in header */
        .header-left, .header-center, .header-right {
            display: flex;
            align-items: center;
        }
        .header-center {
            flex: 1;
            justify-content: center;
        }
        /* Increase the logo size by 30% (from 40px to 52px) */
        .header img {
            height: 52px;
            margin-right: 10px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        /* Save message styling */
        .save-message {
            display: none;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            transition: opacity 0.5s ease-in-out;
            position: absolute;
            right: 20px;
            top: 10px;
            opacity: 0;
        }
        .card {
            background: #83B6FF !important;
        }
        /* Spacer div to push content below the fixed header */
        .spacer {
            height: 60px;
        }
        /* Double horizontal padding for the "Add Item" button */
        .btn-double {
            padding-left: 2rem !important;
            padding-right: 2rem !important;
        }
        #loginContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        #appContent {
            display: none;
        }
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .notebook-sidebar {
            background: #4980C1;
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }
        .notebook-item {
            cursor: pointer;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .notebook-item:hover {
            background-color: #3F72AF;
        }
        .notebook-item.active {
            background-color: #2E5EAA;
            font-weight: bold;
        }
        .progress-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left">
        <img src="nisuext.png" alt="Logo">
    </div>
    <div class="header-center">
        <h1>NISU Teacher</h1>
    </div>
    <div class="header-right">
        <!-- User profile info will appear here after login -->
        <div id="userProfile" class="user-profile" style="display: none;">
            <img id="userAvatar" src="" alt="User">
            <span id="userName"></span>
        </div>
        <button id="logoutButton" class="btn btn-outline-light" style="display: none;" onclick="handleSignOut()">Sign Out</button>
        <button id="saveButton" class="btn btn-success ms-2" onclick="saveChanges()" style="display: none;">Save Changes</button>
    </div>
    <div id="saveMessage" class="save-message">Saved!</div>
</div>

<!-- Spacer to push content below the fixed header -->
<div class="spacer"></div>

<!-- Login container - shown before authentication -->
<div id="loginContainer">
    <h2 class="mb-4">Welcome to NISU Teacher</h2>
    <p class="mb-4">Please sign in with your Google account to continue</p>
    <div id="g_id_onload"
         data-client_id="294376282666-lllnj1ro4d5qu3iq21nmmasr16tjije5.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
</div>

<!-- App content - hidden until authenticated -->
<div id="appContent" class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar with notebooks -->
        <div class="col-md-3">
            <div class="notebook-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="m-0">Notebooks</h4>
                    <button class="btn btn-sm btn-light" onclick="showNewNotebookModal()">
                        <i class="bi bi-plus"></i> New
                    </button>
                </div>
                <div id="notebookList">
                    <!-- Notebook list will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="col-md-9">
            <div id="notebookContent">
                <!-- Current notebook header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 id="currentNotebookName">Select a Notebook</h3>
                    <div>
                        <button id="exportButton" class="btn btn-outline-primary" onclick="exportNotebook()" style="display: none;">
                            Export for Chrome Extension
                        </button>
                    </div>
                </div>
                
                <!-- Add new item form (hidden until notebook is selected) -->
                <div id="addItemForm" class="mb-4" style="display: none;">
                    <div class="d-flex gap-2">
                        <input type="text" id="newCommand" class="form-control" placeholder="Enter content">
                        <select id="contentType" class="form-select">
                            <option value="Prompt">Prompt</option>
                            <option value="Multimedia">Multimedia</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Assignment">Assignment</option>
                            <option value="Website">Website</option>
                        </select>
                        <button class="btn btn-primary btn-lg btn-double" onclick="addItem()">Add Item</button>
                    </div>
                </div>
                
                <!-- Playlist items -->
                <div class="row" id="commandList">
                    <!-- Items will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Notebook Modal -->
<div class="modal fade" id="newNotebookModal" tabindex="-1" aria-labelledby="newNotebookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newNotebookModalLabel">Create New Notebook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newNotebookName" class="form-label">Notebook Name</label>
                    <input type="text" class="form-control" id="newNotebookName" placeholder="Enter a name for your notebook">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewNotebook()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Google Auth variables
    let userToken = '';
    let userData = null;
    
    // App state variables
    let notebooks = [];
    let currentNotebook = null;
    let currentPlaylist = [];
    
    // API endpoints - Update with your deployed App Engine URL
    const API_BASE_URL = 'https://funkeai.uc.r.appspot.com/api';
    // const API_BASE_URL = 'http://localhost:8080/api';
    
    // Check for authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we already have a stored token
        const storedAuthData = localStorage.getItem('authData');
        if (storedAuthData) {
            try {
                const authData = JSON.parse(storedAuthData);
                if (authData.token && authData.expiry > Date.now()) {
                    // Token exists and hasn't expired
                    userToken = authData.token;
                    userData = authData.user;
                    
                    // Display user info
                    document.getElementById('userAvatar').src = userData.picture;
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userProfile').style.display = 'flex';
                    document.getElementById('logoutButton').style.display = 'block';
                    
                    // Hide login, show app
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    
                    // Fetch notebooks
                    fetchNotebooks();
                    return;
                }
            } catch (error) {
                console.error('Error parsing stored auth data:', error);
            }
            // If we got here, token was invalid or expired
            localStorage.removeItem('authData');
        }
        
        // No valid stored token, show login
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('appContent').style.display = 'none';
    });
    
    // Handle first login (create user if needed)
    async function handleFirstLogin() {
        try {
            const response = await fetch(`${API_BASE_URL}/first-user`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userToken}`
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                if (response.status === 403) {
                    // Not authorized
                    alert('You are not authorized to access this application. Please contact an administrator.');
                    handleSignOut();
                    return false;
                }
            }
            
            return true;
        } catch (error) {
            console.error('Error handling first login:', error);
            return false;
        }
    }
    
    // Parse the JWT token
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
    
    // Handle the Google Sign-In response
    async function handleCredentialResponse(response) {
        // Get the token
        userToken = response.credential;
        
        // Decode the JWT token to get user information
        const decodedToken = parseJwt(userToken);
        userData = {
            name: decodedToken.name,
            email: decodedToken.email,
            picture: decodedToken.picture
        };
        
        // Check if this is a valid user
        const isAuthorized = await handleFirstLogin();
        if (!isAuthorized) return;
        
        // Store in localStorage with expiry
        // Set expiry to slightly less than the token expiry (exp is in seconds)
        const expiry = decodedToken.exp * 1000; // Convert to milliseconds
        localStorage.setItem('authData', JSON.stringify({
            token: userToken,
            user: userData,
            expiry: expiry
        }));
        
        // Display user information
        document.getElementById('userAvatar').src = userData.picture;
        document.getElementById('userName').textContent = userData.name;
        document.getElementById('userProfile').style.display = 'flex';
        document.getElementById('logoutButton').style.display = 'block';
        
        // Hide login screen and show app content
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        // Fetch the user's notebooks from the database
        fetchNotebooks();
    }
    
    // Sign out function
    function handleSignOut() {
        google.accounts.id.disableAutoSelect();
        userData = null;
        userToken = '';
        
        // Clear stored auth data
        localStorage.removeItem('authData');
        
        // Hide user profile and app content
        document.getElementById('userProfile').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'none';
        document.getElementById('appContent').style.display = 'none';
        
        // Show login screen
        document.getElementById('loginContainer').style.display = 'block';
    }

    // Fetch all notebooks for the current user
    async function fetchNotebooks() {
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                headers: {
                    'Authorization': `Bearer ${userToken}`
                }
            });
            
            if (!response.ok) {
                // Handle first-time login with no notebooks
                if (response.status === 404) {
                    notebooks = [];
                    displayNotebooks();
                    return;
                }
                throw new Error('Failed to fetch notebooks.');
            }
            
            const data = await response.json();
            notebooks = data.notebooks || [];
            
            // Display the notebooks
            displayNotebooks();
        } catch (error) {
            console.error(error);
            alert('Error fetching notebooks: ' + error.message);
        }
    }
    
    // Display the list of notebooks
    function displayNotebooks() {
        const notebookList = document.getElementById('notebookList');
        notebookList.innerHTML = '';
        
        if (notebooks.length === 0) {
            notebookList.innerHTML = `
                <div class="text-center p-3">
                    <p>No notebooks found.</p>
                    <p>Create your first notebook to get started!</p>
                </div>
            `;
            return;
        }
        
        notebooks.forEach(notebook => {
            const notebookItem = document.createElement('div');
            notebookItem.className = 'notebook-item';
            notebookItem.textContent = notebook.name;
            notebookItem.onclick = () => selectNotebook(notebook);
            
            if (currentNotebook && notebook.name === currentNotebook.name) {
                notebookItem.classList.add('active');
            }
            
            notebookList.appendChild(notebookItem);
        });
    }
    
    // Select a notebook and load its content
    function selectNotebook(notebook) {
        currentNotebook = notebook;
        currentPlaylist = notebook.playlist || [];
        
        // Update UI to show the current notebook
        document.getElementById('currentNotebookName').textContent = notebook.name;
        document.getElementById('addItemForm').style.display = 'block';
        document.getElementById('exportButton').style.display = 'block';
        
        // Display the notebook items
        displayItems(currentPlaylist);
        
        // Update the active notebook in the sidebar
        const notebookItems = document.querySelectorAll('.notebook-item');
        notebookItems.forEach(item => {
            item.classList.remove('active');
            if (item.textContent === notebook.name) {
                item.classList.add('active');
            }
        });
    }
    
    // Show the new notebook modal
    function showNewNotebookModal() {
        const modal = new bootstrap.Modal(document.getElementById('newNotebookModal'));
        modal.show();
    }
    
    // Create a new notebook
    async function createNewNotebook() {
        const notebookName = document.getElementById('newNotebookName').value.trim();
        
        if (!notebookName) {
            alert('Please enter a notebook name.');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({
                    name: notebookName,
                    playlist: []
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to create notebook.');
            }
            
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('newNotebookModal')).hide();
            
            // Clear the input
            document.getElementById('newNotebookName').value = '';
            
            // Refresh the notebooks list
            await fetchNotebooks();
            
            // Select the newly created notebook
            const newNotebook = notebooks.find(n => n.name === notebookName);
            if (newNotebook) {
                selectNotebook(newNotebook);
            }
        } catch (error) {
            console.error(error);
            alert('Error creating notebook: ' + error.message);
        }
    }

    // Generate a unique id for new items
    function generateUniqueId() {
        return 'id-' + Math.random().toString(36).substr(2, 9);
    }

    // Display the list of items in the current notebook
    function displayItems(items) {
        const list = document.getElementById('commandList');
        list.innerHTML = '';
        
        if (!items || items.length === 0) {
            list.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        This notebook is empty. Add your first item above!
                    </div>
                </div>
            `;
            return;
        }
        
        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.setAttribute('data-index', index);
            card.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <small class="text-muted">${item.id || ''}</small>
                        <select class="form-select mb-2" onchange="updateType(${index}, this.value)">
                            <option value="Prompt" ${item.type === 'Prompt' ? 'selected' : ''}>Prompt</option>
                            <option value="Multimedia" ${item.type === 'Multimedia' ? 'selected' : ''}>Multimedia</option>
                            <option value="Quiz" ${item.type === 'Quiz' ? 'selected' : ''}>Quiz</option>
                            <option value="Assignment" ${item.type === 'Assignment' ? 'selected' : ''}>Assignment</option>
                            <option value="Website" ${item.type === 'Website' ? 'selected' : ''}>Website</option>
                        </select>
                        <textarea class="form-control mb-2" rows="3" onchange="editItem(${index}, this.value)">${item.command}</textarea>
                        <button class="btn btn-danger btn-sm" onclick="removeItem(${index})">Remove</button>
                    </div>
                </div>`;
            list.appendChild(card);
        });
        
        // Make the items sortable
        new Sortable(list, {
            animation: 150,
            onEnd: function (evt) {
                const [movedItem] = currentPlaylist.splice(evt.oldIndex, 1);
                currentPlaylist.splice(evt.newIndex, 0, movedItem);
                displayItems(currentPlaylist);
                showSaveButton();
            }
        });
    }

    // Add a new item to the current playlist
    function addItem() {
        if (!currentNotebook) {
            alert('Please select or create a notebook first.');
            return;
        }
        
        const newCommand = document.getElementById('newCommand').value;
        const contentType = document.getElementById('contentType').value;
        
        if (!newCommand.trim()) return;
        
        currentPlaylist.push({ 
            id: generateUniqueId(), 
            command: newCommand, 
            type: contentType || 'Prompt' 
        });
        
        displayItems(currentPlaylist);
        document.getElementById('newCommand').value = '';
        showSaveButton();
    }

    // Show the Save Changes button
    function showSaveButton() {
        document.getElementById('saveButton').style.display = 'block';
    }

    // Edit an existing item
    function editItem(index, value) {
        currentPlaylist[index].command = value;
        showSaveButton();
    }

    // Update the type for an item
    function updateType(index, value) {
        currentPlaylist[index].type = value;
        showSaveButton();
    }

    // Remove an item
    function removeItem(index) {
        currentPlaylist.splice(index, 1);
        displayItems(currentPlaylist);
        showSaveButton();
    }

    // Save the current notebook to the database
    async function saveChanges() {
        if (!currentNotebook) {
            alert('Please select or create a notebook first.');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({
                    name: currentNotebook.name,
                    playlist: currentPlaylist
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save changes to database.');
            }
            
            // Update the notebook in our local array
            const notebookIndex = notebooks.findIndex(n => n.name === currentNotebook.name);
            if (notebookIndex !== -1) {
                notebooks[notebookIndex].playlist = currentPlaylist;
            }
            
            // Hide the Save Changes button
            document.getElementById('saveButton').style.display = 'none';
            
            // Show the save message
            const saveMsg = document.getElementById('saveMessage');
            saveMsg.style.display = 'block';
            saveMsg.style.opacity = '1';
            
            // After 2 seconds, fade out the message
            setTimeout(() => {
                saveMsg.style.opacity = '0';
                // Once fade-out is complete (after 0.5s), hide the message
                setTimeout(() => {
                    saveMsg.style.display = 'none';
                }, 500);
            }, 2000);
        } catch (error) {
            console.error(error);
            alert('Error saving changes: ' + error.message);
        }
    }
    
    // Export the current notebook for Chrome Extension
    function exportNotebook() {
        if (!currentNotebook) {
            alert('Please select a notebook first.');
            return;
        }
        
        try {
            // Create a JSON blob
            const notebookData = {
                name: currentNotebook.name,
                playlist: currentPlaylist
            };
            
            const blob = new Blob([JSON.stringify(notebookData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentNotebook.name.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        } catch (error) {
            console.error(error);
            alert('Error exporting notebook: ' + error.message);
        }
    }
    
    // Initialize Google Sign-In
    window.onload = function() {
        google.accounts.id.initialize({
            client_id: "294376282666-lllnj1ro4d5qu3iq21nmmasr16tjije5.apps.googleusercontent.com",
            callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
            document.getElementById("g_id_signin"),
            { theme: "outline", size: "large" }
        );
    };
</script>
</body>
</html>